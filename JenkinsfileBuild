@Library('global-jenkins-library@2.8.0') _

node('docker') {

    def DOCKER_IMG_NAME
    def DOCKER_IMG
    
    
    stage('Clean Workspace'){
        cleanWs()
    }
    stage('Checkout scm') {
        checkout scm
    }
    stage('Build image') {
        // Get the last commit hash 
        buildInfo = getBuildInfo()

        DOCKER_IMG_NAME = "iexechub/iexec-voucher-subgraph:$buildInfo.shortCommit"

        DOCKER_IMG = docker.build(DOCKER_IMG_NAME, " \
            -f docker/Dockerfile \
            . \
        ")
    }
    stage("Push image to Dockerhub") {
        docker.withRegistry('', 'dockerio') {
            DOCKER_IMG.push()
            DOCKER_IMG.push(buildInfo.imageTag)
        }
        sh "docker image rm ${DOCKER_IMG_NAME}"
    }
}