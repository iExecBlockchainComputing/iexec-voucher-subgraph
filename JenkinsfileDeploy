node('docker') {

    // Global variables
    String DOCKER_IMAGE_VERSION = '8491d157'

    stage('Set properties') {
        properties([
            parameters([
                string(name: 'targetRemoteHost', description: 'Hostname where to deploy the subgraph', defaultValue: '', trim: true),
                string(name: 'networkName', description: 'Network Name', defaultValue: 'bellecour', trim: true),
                string(name: 'voucherHubAddress', description: 'Voucher Hub Address', defaultValue: '0x3137B6DF4f36D338b82260eDBB2E7bab034AFEda', trim: true),
                string(name: 'voucherHubStartBlock', description: 'Start Block for Voucher Hub', defaultValue: '', trim: true),
                string(name: 'versionLabel', description: 'Version Label for Subgraph Deployment', defaultValue: 'develop', trim: true)
            ])
        ])
        println """
            Target remote host env: $params.targetRemoteHost
            Graph Node URL: http://$params.targetRemoteHost:8020
            IPFS URL: http://$params.targetRemoteHost:5001
            Network Name: $params.networkName
            Voucher Hub Address: $params.voucherHubAddress
            Start Block: $params.voucherHubStartBlock
            Version Label: $params.versionLabel
        """
    }

    stage('Clean Workspace') {
        cleanWs()
    }

    stage('Checkout scm') {
        checkout scm
    }

    stage('Run operation') {
        withCredentials([
            usernamePassword(credentialsId: 'docker-regis', usernameVariable: 'username', passwordVariable: 'password')
        ]) {
            // Login to download Docker image
            sh "echo -n '${password}' | docker login --username '${username}' --password-stdin docker-regis.iex.ec"

            // Run the container for subgraph deployment
            sh """
                docker run \
                    --rm \
                    -e GRAPHNODE_URL='http://$params.targetRemoteHost:8020' \
                    -e IPFS_URL='http://$params.targetRemoteHost:5001' \
                    -e VOUCHER_HUB_ADDRESS='$params.voucherHubAddress' \
                    -e VOUCHER_HUB_START_BLOCK='$params.voucherHubStartBlock' \
                    -e NETWORK_NAME='$params.networkName' \
                    -e VERSION_LABEL='$params.versionLabel' \
                    docker-regis.iex.ec/voucher-subgraph:$DOCKER_IMAGE_VERSION
            """
            
            // Logout to remove docker credentials
            sh "docker logout docker-regis.iex.ec"
        }
        println "The end."
    }
}
